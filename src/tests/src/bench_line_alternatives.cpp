#include <catch2/benchmark/catch_benchmark_all.hpp>
#include <catch2/catch_test_macros.hpp>
#include <picross/picross.h>
#include <utils/test_helpers.h>
#include <utils/text_io.h>

#include "binomial.h"
#include "line.h"
#include "line_alternatives.h"
#include "line_constraint.h"
#include "line_span.h"

namespace picross
{
namespace
{
    BinomialCoefficients::Cache& get_binomial()
    {
        static BinomialCoefficients::Cache binomial;
        return binomial;
    }

    LineAlternatives::Reduction full_reduction(const LineConstraint& constraint, const Line& known_tiles)
    {
        return LineAlternatives(constraint, known_tiles, get_binomial()).full_reduction();
    }

    LineAlternatives::Reduction partial_reduction(const LineConstraint& constraint, const Line& known_tiles, unsigned int nb_constraints)
    {
        return LineAlternatives(constraint, known_tiles, get_binomial()).partial_reduction(nb_constraints);
    }
}

TEST_CASE("Benchmark", "[line_alternatives]")
{
    // Example from webpbn-03528-only-one.non
    {
        const LineConstraint constraint(Line::COL, { 3, 2, 4, 3, 1, 1, 2, 17, 2 });
        const auto known_tiles    = build_line_from("..????????????????????#?????????????????????????????????????", Line::COL, 17);
        const auto expected_delta = build_line_from("????????????????????????????????????????##??????????????????", Line::COL, 17);
        LineAlternatives::Reduction reduction;
        bool bench_run = false;
        BENCHMARK("COL 17") {
            reduction = full_reduction(constraint, known_tiles);
            return bench_run = true;
        };
        if (bench_run)
        {
            CHECK((reduction.reduced_line - known_tiles) == expected_delta);
            CHECK(reduction.nb_alternatives == 618206);
            CHECK(reduction.is_fully_reduced);
        }
    }
#if 0
    // Example from tiger.non
    {
        const LineConstraint constraint(Line::ROW, { 2, 2, 2, 2, 3, 4, 2, 2, 3 });
        const auto known_tiles    = build_line_from("???????????...???????.?????????????.?..?.?????????????????#??????????????..", Line::ROW, 45);
        const auto expected_delta = build_line_from("????????????????????????????????????.??.???????????????????????????????????", Line::ROW, 45);
        LineAlternatives::Reduction reduction;
        bool bench_run = false;
        BENCHMARK("ROW 45") {
            reduction = full_reduction(constraint, known_tiles);
            return bench_run = true;
        };
        if (bench_run)
        {
            CHECK((reduction.reduced_line - known_tiles) == expected_delta);
            CHECK(reduction.nb_alternatives == 8714484);
            CHECK(reduction.is_fully_reduced);
        }
    }
    // Example from tiger.non
    {
        const LineConstraint constraint(Line::ROW, { 1, 2, 2, 1, 12, 1, 2, 2 });
        const auto known_tiles    = build_line_from("???????????...???????..???????????###??###???????????????????????????????..", Line::ROW, 46);
        const auto expected_delta = build_line_from("?????????????????????????????????????##????????????????????????????????????", Line::ROW, 46);
        LineAlternatives::Reduction reduction;
        bool bench_run = false;
        BENCHMARK("ROW 46") {
            reduction = full_reduction(constraint, known_tiles);
            return bench_run = true;
        };
        if (bench_run)
        {
            CHECK((reduction.reduced_line - known_tiles) == expected_delta);
            CHECK(reduction.nb_alternatives == 49441874);
            CHECK(reduction.is_fully_reduced);
        }
    }
#endif
    // Example from tiger.non
    {
        const LineConstraint constraint(Line::ROW, { 2, 2, 3, 3, 2, 3, 2, 2 });
        const auto known_tiles    = build_line_from("???????????...???????...???????????#....##???????????????????????????????..", Line::ROW, 48);
        const auto expected_delta = build_line_from("??????????????????????????????????#????????????????????????????????????????", Line::ROW, 48);
        LineAlternatives::Reduction reduction;
        bool bench_run = false;
        BENCHMARK("ROW 48") {
            reduction = full_reduction(constraint, known_tiles);
            return bench_run = true;
        };
        if (bench_run)
        {
            CHECK((reduction.reduced_line - known_tiles) == expected_delta);
            CHECK(reduction.nb_alternatives == 3873724);
            CHECK(reduction.is_fully_reduced);
        }
    }
}

} // namespace picross
